{% extends "base.html" %}
{% block content %}
<div class="card">
  <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
    <div>
      <div class="pill">Thirrja #{{ request_id }}</div>
      <h1>{{ request_data.title }}</h1>
      <p class="muted">{{ request_data.location }}</p>
      <p>{{ request_data.description }}</p>
      {% if request_data.imageUrl %}
        <img src="{{ request_data.imageUrl }}" alt="Foto" style="width:100%; max-width:520px; border-radius:12px; margin:10px 0; object-fit:cover;">
      {% endif %}
      <p class="muted">Status: <strong>{{ request_data.status }}</strong></p>
      <p class="muted">Pronar: <a href="/profiles/{{ request_data.ownerId }}/">{{ request_data.ownerName }}</a></p>
      {% if request_data.acceptedVolunteerId %}
        <p>Vullnetari i pranuar: <a href="/profiles/{{ request_data.acceptedVolunteerId }}/">{{ request_data.acceptedVolunteerName }}</a></p>
      {% else %}
        <p class="muted">Ende pa vullnetar të pranuar</p>
      {% endif %}
    </div>
    {% if request_data.acceptedVolunteerId and request_data.status == "IN_PROGRESS" and request.session.user.id == request_data.ownerId %}
      <form method="post" action="/requests/{{ request_id }}/complete/">
        {% csrf_token %}
        <button type="submit">Shëno si e përfunduar</button>
      </form>
    {% endif %}
  </div>
</div>

{% if request_data.status == "OPEN" and request.session.user.id != request_data.ownerId %}
<div class="card">
  <h3>Apliko</h3>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="form_type" value="apply">
    {{ form.as_p }}
    <button type="submit">Apliko</button>
  </form>
</div>
{% endif %}

<div class="card">
  <h3>Aplikimet</h3>
  <table>
    <tr>
      <th>Vullnetari</th>
      <th>Statusi</th>
      <th>Mesazhi</th>
      <th>Veprime</th>
    </tr>
    {% for a in applications %}
    <tr>
      <td><a href="/profiles/{{ a.applicantId }}/">{{ a.applicantName }}</a> (ID {{ a.applicantId }})</td>
      <td><span class="pill">{{ a.status }}</span></td>
      <td>{{ a.message }}</td>
      <td>
        {% if request.session.user.id == request_data.ownerId and request_data.status == "OPEN" and a.status == "PENDING" %}
          <form method="post" action="/applications/{{ a.applicationId }}/accept/" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Prano</button>
          </form>
          <form method="post" action="/applications/{{ a.applicationId }}/reject/" style="display:inline;">
            {% csrf_token %}
            <button type="submit">Refuzo</button>
          </form>
        {% else %}
          <span class="muted">S'ka veprim</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </table>
</div>

{% if can_review %}
<div class="card">
  <h3>Vlerëso partnerin</h3>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="form_type" value="review">
    {{ review_form.as_p }}
    <button type="submit">Dërgo vlerësimin</button>
  </form>
  <p class="muted">Vlerësimet hapen vetëm pasi thirrja përfundon.</p>
</div>
{% endif %}

{% if request_data.acceptedVolunteerId %}
<div class="card">
  <h3>Kontakt i shkurtër</h3>
  {% if request.session.user.id == request_data.ownerId %}
    <p>Telefon i vullnetarit: {{ request_data.acceptedVolunteerPhone|default:"(i fshehur)" }}</p>
  {% elif request.session.user.id == request_data.acceptedVolunteerId %}
    <p>Telefon i pronarit: {{ request_data.ownerPhone|default:"(i fshehur)" }}</p>
  {% else %}
    <p class="muted">Kontakti shfaqet vetëm për palët e përfshira.</p>
  {% endif %}
</div>
{% endif %}

{% if volunteer_reviews %}
<div class="card">
  <h3>Vlerësimet e fundit të vullnetarit</h3>
  <div class="reviews">
    {% for rev in volunteer_reviews %}
      <div class="review">
        <div class="pill">{{ rev.rating }}/5</div>
        <p class="muted">{{ rev.reviewerName }}</p>
        <p>{{ rev.comment }}</p>
      </div>
    {% endfor %}
  </div>
</div>
{% endif %}
{% endblock %}
