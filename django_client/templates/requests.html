{% extends "base.html" %}
{% block content %}
<section class="card requests-hero">
  <div class="requests-hero-head">
    <div>
      <p class="eyebrow">Thirrje & kÃ«rkime</p>
      <h1>Gjej ose publiko thirrje</h1>
      <p class="muted">Shfleto thirrjet, filtro sipas nevojave dhe publiko njÃ« kÃ«rkesÃ« tÃ« re pÃ«r ndihmÃ«.</p>
    </div>
    <div class="requests-hero-actions">
      <a class="btn-primary" href="#request-create-form">Krijo thirrje</a>
      <a class="btn-secondary" href="/requests/?tab=open#active-requests">Shfleto tÃ« hapurat</a>
    </div>
  </div>

  <div class="requests-stats">
    <div class="requests-stat">
      <span class="label">TÃ« gjitha</span>
      <strong>{{ all_count|default:0 }}</strong>
    </div>
    <div class="requests-stat">
      <span class="label">TÃ« hapura</span>
      <strong>{{ open_count|default:0 }}</strong>
    </div>
    <div class="requests-stat">
      <span class="label">TÃ« miat</span>
      <strong>{{ mine_count|default:0 }}</strong>
    </div>
  </div>

  <form method="get" class="request-search request-search--hero" action="#active-requests">
    <input type="text" name="q" placeholder="KÃ«rko sipas titullit, vendit ose tekstit" value="{{ q|default:'' }}">
    <input type="hidden" name="tab" value="{{ tab|default:'all' }}">
    <button type="submit" class="btn-primary">Filtro</button>
  </form>

  <div class="request-tabs">
    <a class="request-tab {% if tab == 'all' %}active{% endif %}" href="/requests/?tab=all{% if q %}&q={{ q }}{% endif %}#active-requests">
      TÃ« gjitha
      <span class="tab-count">{{ all_count|default:0 }}</span>
    </a>
    <a class="request-tab {% if tab == 'open' %}active{% endif %}" href="/requests/?tab=open{% if q %}&q={{ q }}{% endif %}#active-requests">
      TÃ« hapura
      <span class="tab-count">{{ open_count|default:0 }}</span>
    </a>
    <a class="request-tab {% if tab == 'mine' %}active{% endif %}" href="/requests/?tab=mine{% if q %}&q={{ q }}{% endif %}#active-requests">
      TÃ« miat
      {% if mine_count is not None %}
        <span class="tab-count">{{ mine_count }}</span>
      {% endif %}
    </a>
  </div>
</section>

<div class="requests-layout">
  <div class="requests-main">
    <div class="card" id="active-requests">
  <div class="section-head">
    <div>
      <p class="eyebrow">Thirrjet aktive</p>
      <h3>ğŸ“¦ TÃ« gjitha thirrjet</h3>
      <p class="muted">Menaxho statusin, shiko aplikimet dhe ndiq progresin.</p>
    </div>
  </div>
      {% if requests %}
      <div class="card-grid">
        {% for r in requests %}
        <div class="request-card">
          {% if r.imageUrl %}
            <img src="{{ r.imageUrl }}" alt="foto">
          {% else %}
            <div class="request-image-fallback">ğŸ“¸</div>
          {% endif %}
          <div class="request-card-body">
            <div class="request-card-top">
              <div class="request-id">#{{ r.id }}</div>
              <span class="status-pill" data-status="{{ r.status }}">{{ r.status }}</span>
            </div>
            <h4 class="request-title"><a href="/requests/{{ r.id }}/">{{ r.title }}</a></h4>
            <div class="request-meta">
              <span class="request-meta-item">ğŸ“ {{ r.location }}</span>
              <span class="request-meta-item">ğŸ‘¤ <a href="/profiles/{{ r.ownerId }}/">{{ r.ownerName }}</a></span>
              {% if r.acceptedVolunteerId %}
                <span class="request-meta-item">âœ… <a href="/profiles/{{ r.acceptedVolunteerId }}/">{{ r.acceptedVolunteerName }}</a></span>
              {% else %}
                <span class="request-meta-item">â³ Pa vullnetar</span>
              {% endif %}
            </div>
            <div class="chip-row request-card-actions">
              <a class="chip link" href="/requests/{{ r.id }}/">Detajet</a>
              {% if request.session.user.id != r.ownerId %}
                <a class="chip" href="/requests/{{ r.id }}/#apply">Apliko</a>
              {% endif %}
            </div>
            <div class="request-owner-actions">
              {% if request.session.user.id == r.ownerId %}
                {% if r.status == "IN_PROGRESS" %}
                  <form method="post" action="/requests/{{ r.id }}/complete/">
                    {% csrf_token %}
                    <button type="submit">âœ… PÃ«rfundo</button>
                  </form>
                {% endif %}
                {% if r.status != "CANCELLED" and r.status != "COMPLETED" %}
                  <form method="post" action="/requests/{{ r.id }}/cancel/">
                    {% csrf_token %}
                    <button type="submit" class="ghost-btn">âŒ Anulo</button>
                  </form>
                {% endif %}
              {% else %}
                <span class="muted">VetÃ«m pronari ka veprime</span>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <span class="empty-state-icon">ğŸ“­</span>
        <h3>Nuk ka thirrje</h3>
        <p class="muted">Krijo thirrjen e parÃ« ose shfleto thirrjet e hapura.</p>
        <div class="form-actions" style="margin-top:12px;">
          <button type="submit" form="request-create-form" class="btn-primary">Krijo thirrje</button>
          <a class="btn-secondary" href="/requests/?tab=open#active-requests">Shfleto tÃ« hapurat</a>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <aside class="requests-side">
    <div class="card request-create">
      <div class="section-head">
        <div>
          <p class="eyebrow">Krijo thirrje</p>
          <h2>Publiko njÃ« thirrje pÃ«r ndihmÃ«</h2>
          <p class="muted">Shkruaj qartÃ« Ã§farÃ« tÃ« duhet dhe ku ndodhet kÃ«rkesa.</p>
        </div>
      </div>

      <form method="post" enctype="multipart/form-data" id="request-create-form" class="request-form">
        {% csrf_token %}
        <div class="form-grid">
          <div class="form-field">
            <label for="id_title">Titulli</label>
            {{ form.title }}
          </div>
          <div class="form-field">
            <label for="id_location">Vendndodhja</label>
            {{ form.location }}
          </div>
        </div>

        <div class="form-field">
          <label for="id_description">PÃ«rshkrimi</label>
          {{ form.description }}
          <p class="muted">Shto sa mÃ« shumÃ« detaje, qÃ« vullnetarÃ«t ta kuptojnÃ« menjÃ«herÃ«.</p>
        </div>

        <input type="hidden" name="imageUrl" id="request-image-url">
        <div class="upload-card" id="request-upload-card">
          <div class="upload-info">
            <h4>Foto e thirrjes</h4>
            <p class="muted">Opsionale. NjÃ« foto e qartÃ« e bÃ«n situatÃ«n mÃ« tÃ« kuptueshme.</p>
          </div>
          <div class="upload-actions">
            <input type="file" id="request-image-file" accept="image/*">
            <span class="upload-status muted" id="request-image-status">Zgjidh njÃ« foto pÃ«r ngarkim automatik</span>
          </div>
          <div class="upload-preview" id="request-image-preview">
            <span class="muted">Pamja paraprake shfaqet kÃ«tu</span>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary">Krijo thirrjen</button>
          <span class="muted">Do tÃ« shfaqet menjÃ«herÃ« pÃ«r vullnetarÃ«t.</span>
        </div>
      </form>
    </div>
  </aside>
</div>

<script>
  (function(){
    const fileInput = document.getElementById('request-image-file');
    const statusEl = document.getElementById('request-image-status');
    const previewEl = document.getElementById('request-image-preview');
    if (!fileInput || !statusEl || !previewEl) return;
    const setStatus = (text, isError=false) => {
      statusEl.textContent = text;
      statusEl.style.color = isError ? '#dc2626' : '';
    };
    const compressImage = (file) => new Promise((resolve, reject) => {
      const img = new Image();
      const url = URL.createObjectURL(file);
      img.onload = () => {
        const maxSize = 1600;
        let { width, height } = img;
        if (width > height && width > maxSize) {
          height = Math.round((height * maxSize) / width);
          width = maxSize;
        } else if (height >= width && height > maxSize) {
          width = Math.round((width * maxSize) / height);
          height = maxSize;
        }
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        const outputType = file.type === 'image/png' ? 'image/png' : 'image/jpeg';
        if (outputType === 'image/jpeg') {
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, width, height);
        }
        ctx.drawImage(img, 0, 0, width, height);
        canvas.toBlob((blob) => {
          URL.revokeObjectURL(url);
          if (!blob) {
            reject(new Error('DÃ«shtoi kompresimi i fotos'));
            return;
          }
          resolve({ blob, type: outputType });
        }, outputType, outputType === 'image/jpeg' ? 0.8 : 0.92);
      };
      img.onerror = () => {
        URL.revokeObjectURL(url);
        reject(new Error('Foto e pavlefshme'));
      };
      img.src = url;
    });

    const uploadFile = async (blob, filename, mimeType) => {
      const fd = new FormData();
      fd.append('file', new File([blob], filename, { type: mimeType }));
      const res = await fetch((window.API_BASE_URL || "http://localhost:8080").replace(/\/+$/,'') + "/api/files/request", {
        method: 'POST',
        headers: {"Authorization": "Bearer {{ request.session.token|default:'' }}"},
        body: fd
      });
      if (!res.ok) { throw new Error('Ngarkimi dÃ«shtoi'); }
      return res.json();
    };

    const handleFile = async (file) => {
      try {
        setStatus('Duke kompresuar foton...');
        const compressed = await compressImage(file);
        const previewUrl = URL.createObjectURL(compressed.blob);
        previewEl.innerHTML = '<img alt="Pamja paraprake" src="' + previewUrl + '">';
        setStatus('Duke ngarkuar foton...');
        const ext = compressed.type === 'image/png' ? '.png' : '.jpg';
        const filename = (file.name ? file.name.replace(/\.[^/.]+$/, '') : 'request') + ext;
        const data = await uploadFile(compressed.blob, filename, compressed.type);
        document.getElementById('request-image-url').value = data.url;
        setStatus('Foto u ngarkua me sukses');
      } catch (err) {
        setStatus(err.message || 'Ngarkimi dÃ«shtoi', true);
      }
    };

    fileInput.addEventListener('change', async () => {
      if (!fileInput.files.length) {
        previewEl.innerHTML = '<span class="muted">Pamja paraprake shfaqet kÃ«tu</span>';
        setStatus('Zgjidh njÃ« foto pÃ«r ngarkim automatik');
        return;
      }
      await handleFile(fileInput.files[0]);
    });
    const uploadCard = document.getElementById('request-upload-card');
    if (uploadCard) {
      uploadCard.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadCard.classList.add('dragging');
      });
      uploadCard.addEventListener('dragleave', () => uploadCard.classList.remove('dragging'));
      uploadCard.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadCard.classList.remove('dragging');
        if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          fileInput.dispatchEvent(new Event('change'));
        }
      });
    }
  })();
</script>
{% endblock %}
