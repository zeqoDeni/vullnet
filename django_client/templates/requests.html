{% extends "base.html" %}
{% block content %}
<div class="card">
  <h1>Thirrjet</h1>
  <form method="get" style="margin-bottom:12px;">
    <input type="text" name="q" placeholder="Kërko për titull/vend/tekst" value="{{ q|default:'' }}">
    <button type="submit" class="pill">Filtro</button>
  </form>
  <h3>Krijo thirrje të re</h3>
  <form method="post" enctype="multipart/form-data" id="request-create-form">
    {% csrf_token %}
    {{ form.as_p }}
    <input type="hidden" name="imageUrl" id="request-image-url">
    <label>Foto e thirrjes (opsionale):</label>
    <input type="file" id="request-image-file">
    <button type="button" class="pill" id="upload-request-image">Ngarko foton</button>
    <button type="submit">Krijo</button>
  </form>
</div>

<div class="card">
  <h3>Të gjitha thirrjet</h3>
  <div class="card-grid">
    {% for r in requests %}
    <div class="request-card">
      {% if r.imageUrl %}
        <img src="{{ r.imageUrl }}" alt="foto">
      {% else %}
        <div style="width:88px; height:88px; border:1px dashed var(--border); border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:12px;">Pa foto</div>
      {% endif %}
      <div class="request-card-body">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <div class="pill">#{{ r.id }}</div>
          <span class="status-pill" data-status="{{ r.status }}">{{ r.status }}</span>
        </div>
        <h4 style="margin:4px 0 0 0;"><a href="/requests/{{ r.id }}/">{{ r.title }}</a></h4>
        <p class="muted">{{ r.location }}</p>
        <p class="muted">Pronar: <a href="/profiles/{{ r.ownerId }}/">{{ r.ownerName }}</a></p>
        {% if r.acceptedVolunteerId %}
          <p class="muted">Vullnetari: <a href="/profiles/{{ r.acceptedVolunteerId }}/">{{ r.acceptedVolunteerName }}</a></p>
        {% else %}
          <p class="muted">Pa vullnetar</p>
        {% endif %}
        <div class="chip-row" style="margin-top:6px;">
          <a class="chip link" href="/requests/{{ r.id }}/">Detajet</a>
          {% if request.session.user.id != r.ownerId %}
            <a class="chip" href="/requests/{{ r.id }}/#apply">Apliko</a>
          {% endif %}
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;">
          {% if request.session.user.id == r.ownerId %}
            {% if r.status == "IN_PROGRESS" %}
              <form method="post" action="/requests/{{ r.id }}/complete/">
                {% csrf_token %}
                <button type="submit">Përfundo</button>
              </form>
            {% endif %}
            {% if r.status != "CANCELLED" and r.status != "COMPLETED" %}
              <form method="post" action="/requests/{{ r.id }}/cancel/">
                {% csrf_token %}
                <button type="submit" class="ghost-btn">Anulo</button>
              </form>
            {% endif %}
          {% else %}
            <span class="muted">Veprime për pronarin</span>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  (function(){
    const uploadBtn = document.getElementById('upload-request-image');
    if (!uploadBtn) return;
    uploadBtn.addEventListener('click', async () => {
      const fileInput = document.getElementById('request-image-file');
      if (!fileInput.files.length) { alert('Zgjidh një foto'); return; }
      const fd = new FormData();
      fd.append('file', fileInput.files[0]);
      try {
        const res = await fetch((window.API_BASE_URL || "http://localhost:8080").replace(/\/+$/,'') + "/api/files/request", {
          method: 'POST',
          headers: {"Authorization": "Bearer {{ request.session.token|default:'' }}"},
          body: fd
        });
        if (!res.ok) { throw new Error('Ngarkimi dështoi'); }
        const data = await res.json();
        document.getElementById('request-image-url').value = data.url;
        alert('Foto u ngarkua');
      } catch (err) {
        alert(err.message);
      }
    });
  })();
</script>
{% endblock %}
